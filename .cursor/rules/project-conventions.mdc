---
description: 飞书机器人项目的通用开发规范，涵盖架构约定、文件维护、代码风格
alwaysApply: true
---

# 项目规范

## 文件维护

- 新增、删除或重命名文件后，必须同步更新 `FileTree.md`，保持文件索引与实际结构一致
- 修改文件职责（如新增公共方法、改变模块定位）后，更新 `FileTree.md` 中对应文件的说明
- 架构发生变化（如新增链路、修改数据流）时，同步更新 `README.md` 中的架构图和链路说明

## 架构约定

- **消息去重**：所有消息处理必须先通过 `store.TryMarkMessageProcessed()`（Redis SETNX），通过后再处理
- **会话锁**：同一 chatID 的消息必须串行处理，通过 `getChatLock(chatID)` 获取互斥锁
- **信息累积**：`conv.CollectedInfo` 是信息的唯一真相源，LLM 只负责从单条消息提取，代码负责合并
- **LLM 无历史**：调用 LLM 时只传当前消息 + 已收集信息快照，不传对话历史
- **自动转人工**：4 项必填信息齐全后自动触发，返回 `EscalatePrefix + 用户消息` 格式

## 代码风格

- 日志使用结构化标签：`[Event]`、`[Manager]`、`[LLM]`、`[Escalation]`、`[DEDUP]`、`[Feishu]`、`[Handler]`、`[Clear]`
- 错误处理：返回 `fmt.Errorf("描述: %w", err)` 包装错误，上层决定是否 log
- 飞书 API 调用后检查 `resp.Success()`，失败时记录 code 和 msg
- 配置支持环境变量覆盖，格式为 `FEISHU_APP_ID`、`LLM_API_KEY` 等大写下划线

## 测试与部署

- 修改代码后先 `go build ./...` 确认编译通过
- 部署使用 `docker compose up -d --build`
- 查看日志使用 `docker compose logs -f bot`
